<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tạo Đơn Hàng - Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display:block; margin-top:8px; }
    input[type="text"], input[type="number"] { padding:6px; width:280px; }
    table { border-collapse: collapse; margin-top:10px; width:100%; max-width:800px; }
    table th, table td { border:1px solid #ccc; padding:6px; text-align:left; }
    .small { width:120px; }
    .btn { padding:6px 10px; margin-top:8px; cursor:pointer; }
    .flex { display:flex; gap:10px; align-items:center; }
    pre { background:#f6f6f6; padding:12px; border:1px solid #ddd; overflow:auto; max-height:320px; }
  </style>
</head>
<body>
  <h1>Tạo đơn hàng (Demo)</h1>

  <div>
    <label>Mã đơn hàng (chuỗi)
      <input id="orderId" type="text" placeholder="VD: ORD-20250925-001" />
    </label>

    <fieldset style="margin-top:10px; padding:10px; max-width:520px;">
      <legend>Thông tin khách hàng</legend>
      <label>Họ tên
        <input id="custName" type="text" placeholder="Nguyễn Văn A" />
      </label>
      <label>Số điện thoại
        <input id="custPhone" type="text" placeholder="096xxxxxxx" />
      </label>
      <label class="flex">
        <input id="custMember" type="checkbox" /> Thành viên thân thiết (boolean)
      </label>
    </fieldset>

    <fieldset style="margin-top:10px; padding:10px; max-width:800px;">
      <legend>Danh sách sản phẩm</legend>

      <div class="flex">
        <input id="prodId" type="text" placeholder="Mã sản phẩm" class="small" />
        <input id="prodName" type="text" placeholder="Tên sản phẩm" />
        <input id="prodQty" type="number" min="1" value="1" class="small" />
        <input id="prodPrice" type="number" min="0" step="0.01" value="0.00" class="small" />
        <button id="addProd" class="btn">Thêm</button>
      </div>

      <table id="productsTable" aria-label="Products">
        <thead>
          <tr>
            <th>#</th>
            <th>Mã</th>
            <th>Tên</th>
            <th>Số lượng</th>
            <th>Giá (một sp)</th>
            <th>Thành tiền</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </fieldset>

    <label class="flex" style="margin-top:10px;">
      <input id="paymentStatus" type="checkbox" /> Trạng thái thanh toán (đã thanh toán = true)
    </label>

    <label>Địa chỉ giao hàng
      <input id="address" type="text" placeholder="Số nhà, đường, quận, TP..." style="width:520px;" />
    </label>

    <div style="margin-top:12px;">
      <button id="createOrder" class="btn">Tạo object đơn hàng</button>
      <button id="clearAll" class="btn">Xóa tất cả</button>
    </div>

    <h3>Kết quả (object JSON & tổng tiền)</h3>
<div>
      <strong>Tổng tiền:</strong> <span id="totalPrice">0.00</span> VNĐ
    </div>
    <pre id="output">{}</pre>
  </div>

  <script>
    // trạng thái sản phẩm tạm thời
    const products = [];

    const elements = {
      prodId: document.getElementById('prodId'),
      prodName: document.getElementById('prodName'),
      prodQty: document.getElementById('prodQty'),
      prodPrice: document.getElementById('prodPrice'),
      addProd: document.getElementById('addProd'),
      productsTableBody: document.querySelector('#productsTable tbody'),
      totalPrice: document.getElementById('totalPrice'),
      output: document.getElementById('output'),
      createOrder: document.getElementById('createOrder'),
      clearAll: document.getElementById('clearAll'),
    };

    function renderProducts() {
      const tbody = elements.productsTableBody;
      tbody.innerHTML = '';
      let total = 0;
      products.forEach((p, i) => {
        const row = document.createElement('tr');
        const lineTotal = (p.quantity * p.price);
        total += lineTotal;
        row.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(p.id)}</td>
          <td>${escapeHtml(p.name)}</td>
          <td>${p.quantity}</td>
          <td>${p.price.toFixed(2)}</td>
          <td>${lineTotal.toFixed(2)}</td>
          <td><button data-index="${i}" class="removeBtn">Xóa</button></td>
        `;
        tbody.appendChild(row);
      });

      elements.totalPrice.textContent = total.toFixed(2);
      // gắn sự kiện xóa
      tbody.querySelectorAll('.removeBtn').forEach(btn =>
        btn.addEventListener('click', (e) => {
          const idx = Number(e.target.dataset.index);
          products.splice(idx,1);
          renderProducts();
        })
      );
    }

    elements.addProd.addEventListener('click', () => {
      const id = elements.prodId.value.trim();
      const name = elements.prodName.value.trim();
      const qty = Number(elements.prodQty.value);
      const price = Number(elements.prodPrice.value);

      if (!id || !name || qty <= 0 || price < 0 || Number.isNaN(qty) || Number.isNaN(price)) {
        alert('Vui lòng nhập đầy đủ và hợp lệ: Mã, Tên, Số lượng (>0), Giá (>=0).');
        return;
      }

      products.push({
        id: String(id),
        name: String(name),
        quantity: qty,
        price: price
      });

      // reset input nhỏ
      elements.prodId.value = '';
      elements.prodName.value = '';
      elements.prodQty.value = 1;
      elements.prodPrice.value = '0.00';
      renderProducts();
    });

    elements.createOrder.addEventListener('click', () => {
      // Lấy thông tin từ form
      const orderId = document.getElementById('orderId').value.trim() || `ORD-${Date.now()}`;
      const custName = document.getElementById('custName').value.trim();
      const custPhone = document.getElementById('custPhone').value.trim();
const custMember = document.getElementById('custMember').checked;
      const paymentStatus = document.getElementById('paymentStatus').checked;
      const address = document.getElementById('address').value.trim();

      if (!custName || !custPhone) {
        if (!confirm('Tên hoặc điện thoại khách hàng trống. Bạn có muốn tiếp tục?')) return;
      }

      // Tạo object theo spec:
      const order = {
        orderId: String(orderId),                 // Mã đơn hàng (chuỗi)
        customer: {                               // Thông tin khách hàng (object)
          name: custName ? String(custName) : '',
          phone: custPhone ? String(custPhone) : '',
          isLoyalMember: Boolean(custMember)      // boolean
        },
        products: products.map(p => ({            // Danh sách sản phẩm
          productId: String(p.id),                // mã sản phẩm
          productName: String(p.name),            // tên sản phẩm
          quantity: Number(p.quantity),           // số lượng (number)
          unitPrice: Number(p.price)              // giá tiền 1 sản phẩm (number)
        })),
        paymentStatus: Boolean(paymentStatus),    // boolean
        deliveryAddress: address ? String(address) : ''
      };

      // Tính tổng tiền (tùy ý)
      order.total = order.products.reduce((s, it) => s + (it.quantity * it.unitPrice), 0);

      // Hiển thị JSON đẹp
      elements.output.textContent = JSON.stringify(order, null, 2);
      elements.totalPrice.textContent = order.total.toFixed(2);
    });

    elements.clearAll.addEventListener('click', () => {
      if (!confirm('Xóa tất cả dữ liệu hiện tại?')) return;
      products.length = 0;
      renderProducts();
      document.getElementById('orderId').value = '';
      document.getElementById('custName').value = '';
      document.getElementById('custPhone').value = '';
      document.getElementById('custMember').checked = false;
      document.getElementById('paymentStatus').checked = false;
      document.getElementById('address').value = '';
      elements.output.textContent = '{}';
      elements.totalPrice.textContent = '0.00';
    });

    // helper nhỏ để tránh XSS khi hiển thị trong table
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // khởi tạo
    renderProducts();
  </script>
</body>
</html>